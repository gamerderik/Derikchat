<DOCUMENT filename="index.html">
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DerikChat - Public Chat App</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>

<div class="container">
    <header>
        <h1><i class="fas fa-comments"></i> DerikChat</h1>
        <p>Public chat • Real-time • Everyone can see messages</p>
    </header>

    <!-- Login / Register Forms (shown when not logged in) -->
    <div id="auth-section">
        <div class="auth-container">
            <h2 style="margin-bottom: 25px; color: var(--primary);">Login to Chat</h2>
            <form id="login-form">
                <div class="form-group">
                    <label for="login-username">Username</label>
                    <input type="text" id="login-username" class="form-control" placeholder="Enter your username" required>
                </div>
                <div class="form-group">
                    <label for="login-password">Password</label>
                    <input type="password" id="login-password" class="form-control" placeholder="Enter your password" required>
                </div>
                <button type="submit" class="btn">Login</button>
                <p class="text-center" style="margin-top: 20px;">
                    Don't have an account? <a href="#" id="show-register" class="link">Register here</a>
                </p>
            </form>

            <form id="register-form" style="display: none;">
                <div class="form-group">
                    <label for="reg-username">Choose Username</label>
                    <input type="text" id="reg-username" class="form-control" placeholder="Pick a unique username" required>
                </div>
                <div class="form-group">
                    <label for="reg-password">Choose Password</label>
                    <input type="password" id="reg-password" class="form-control" placeholder="Create a strong password" required>
                </div>
                <button type="submit" class="btn">Create Account</button>
                <p class="text-center" style="margin-top: 20px;">
                    Already have an account? <a href="#" id="show-login" class="link">Login here</a>
                </p>
            </form>

            <div id="auth-error" class="error-message" style="display: none; margin-top: 15px;"></div>
        </div>
    </div>

    <!-- Chat Interface (shown when logged in) -->
    <div id="chat-section" style="display: none;">
        <div class="chat-container">
            <div class="chat-header">
                <div>
                    <h2><i class="fas fa-globe"></i> Public Room</h2>
                    <div class="user-info">Logged in as <span id="current-username"></span></div>
                </div>
                <button class="logout-btn" id="logout-btn">Logout</button>
            </div>

            <div class="messages-area" id="messages-area">
                <!-- Messages will be appended here -->
            </div>

            <div class="input-area">
                <textarea id="message-input" placeholder="Type your message... (Shift+Enter for new line)"></textarea>
                <button id="send-btn"><i class="fas fa-paper-plane"></i></button>
            </div>

            <div class="admin-panel">
                <form id="clear-form" style="display: inline;">
                    <input type="password" id="admin-pass" placeholder="Admin password" required>
                    <button type="submit">Clear All Messages</button>
                </form>
                <div id="clear-error" style="color: var(--danger); margin-top: 8px; display: none;"></div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/socket.io@4.7.2/client-dist/socket.io.min.js"></script>
<script>
    // === CONFIGURATION ===
    const ADMIN_PASSWORD = 'admin123'; // Change in production!
    const API_BASE = ''; // Same origin

    // === DOM Elements ===
    const authSection = document.getElementById('auth-section');
    const chatSection = document.getElementById('chat-section');
    const loginForm = document.getElementById('login-form');
    const registerForm = document.getElementById('register-form');
    const showRegister = document.getElementById('show-register');
    const showLogin = document.getElementById('show-login');
    const authError = document.getElementById('auth-error');
    
    const messagesArea = document.getElementById('messages-area');
    const messageInput = document.getElementById('message-input');
    const sendBtn = document.getElementById('send-btn');
    const currentUsernameEl = document.getElementById('current-username');
    const logoutBtn = document.getElementById('logout-btn');
    
    const clearForm = document.getElementById('clear-form');
    const adminPass = document.getElementById('admin-pass');
    const clearError = document.getElementById('clear-error');

    // === State ===
    let currentUser = null;
    let socket = null;

    // === Utility Functions ===
    function showError(element, message) {
        element.textContent = message;
        element.style.display = 'block';
        setTimeout(() => element.style.display = 'none', 5000);
    }

    function formatTime(timestamp) {
        const date = new Date(timestamp);
        return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }

    function createMessageElement(msg) {
        const isOwn = msg.username === currentUser;
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${isOwn ? 'own' : ''}`;
        
        const bubble = document.createElement('div');
        bubble.className = 'message-bubble';
        
        const username = document.createElement('div');
        username.className = 'username';
        username.textContent = msg.username;
        
        const content = document.createElement('div');
        content.innerHTML = msg.message;
        
        const time = document.createElement('div');
        time.className = 'timestamp';
        time.textContent = formatTime(msg.timestamp);
        
        bubble.appendChild(username);
        bubble.appendChild(content);
        bubble.appendChild(time);
        messageDiv.appendChild(bubble);
        
        return messageDiv;
    }

    function scrollToBottom() {
        messagesArea.scrollTop = messagesArea.scrollHeight;
    }

    function adjustTextareaHeight() {
        messageInput.style.height = 'auto';
        messageInput.style.height = Math.min(messageInput.scrollHeight, 120) + 'px';
    }

    // === Authentication ===
    showRegister.addEventListener('click', (e) => {
        e.preventDefault();
        loginForm.style.display = 'none';
        registerForm.style.display = 'block';
        authError.style.display = 'none';
    });

    showLogin.addEventListener('click', (e) => {
        e.preventDefault();
        registerForm.style.display = 'none';
        loginForm.style.display = 'block';
        authError.style.display = 'none';
    });

    loginForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const username = document.getElementById('login-username').value.trim();
        const password = document.getElementById('login-password').value;

        try {
            const response = await fetch(`${API_BASE}/api/login`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, password }),
                credentials: 'include'
            });

            const data = await response.json();
            if (response.ok) {
                startChat(username);
            } else {
                showError(authError, data.error || 'Login failed');
            }
        } catch (err) {
            showError(authError, 'Network error. Please try again.');
        }
    });

    registerForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const username = document.getElementById('reg-username').value.trim();
        const password = document.getElementById('reg-password').value;

        if (password.length < 4) {
            showError(authError, 'Password must be at least 4 characters');
            return;
        }

        try {
            const response = await fetch(`${API_BASE}/api/register`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, password }),
                credentials: 'include'
            });

            const data = await response.json();
            if (response.ok) {
                startChat(username);
            } else {
                showError(authError, data.error || 'Registration failed');
            }
        } catch (err) {
            showError(authError, 'Network error. Please try again.');
        }
    });

    // === Chat Functions ===
    function startChat(username) {
        currentUser = username;
        currentUsernameEl.textContent = username;
        
        authSection.style.display = 'none';
        chatSection.style.display = 'block';

        socket = io(API_BASE, { 
            transports: ['websocket'],
            reconnectionAttempts: 5
        });

        socket.on('connect', () => console.log('Connected'));

        socket.on('load_messages', (messages) => {
            messagesArea.innerHTML = '';
            messages.forEach(msg => messagesArea.appendChild(createMessageElement(msg)));
            scrollToBottom();
        });

        socket.on('new_message', (msg) => {
            messagesArea.appendChild(createMessageElement(msg));
            scrollToBottom();
        });

        socket.on('messages_cleared', () => {
            messagesArea.innerHTML = '';
        });
    }

    // === Message Sending ===
    function sendMessage() {
        const message = messageInput.value.trim();
        if (!message || !socket) return;

        socket.emit('send_message', { message });
        messageInput.value = '';
        adjustTextareaHeight();
    }

    sendBtn.addEventListener('click', sendMessage);

    messageInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });

    messageInput.addEventListener('input', adjustTextareaHeight);

    // === Admin Clear ===
    clearForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const pass = adminPass.value;
        
        if (pass === ADMIN_PASSWORD) {
            socket.emit('clear_messages');
            adminPass.value = '';
            clearError.style.display = 'none';
        } else {
            showError(clearError, 'Incorrect admin password');
        }
    });

    // === Logout ===
    logoutBtn.addEventListener('click', async () => {
        try {
            await fetch(`${API_BASE}/api/logout`, { method: 'POST', credentials: 'include' });
        } catch (err) {}

        if (socket) socket.disconnect();
        currentUser = null;
        chatSection.style.display = 'none';
        authSection.style.display = 'block';
        loginForm.style.display = 'block';
        registerForm.style.display = 'none';
        messagesArea.innerHTML = '';
    });

    // === Check Session on Load ===
    window.addEventListener('load', async () => {
        try {
            const response = await fetch(`${API_BASE}/api/check_session`, { credentials: 'include' });
            const data = await response.json();
            if (data.logged_in) startChat(data.username);
        } catch (err) {}
    });
</script>

</body>
</html>
</DOCUMENT>
